
Database             Time                 Version
-------------------- -------------------- ------------------------------
Start: ORCL          26-MAR-2020 11:48:07 Version 19.3.0.0.0


PL/SQL procedure successfully completed.


Table truncated.


9999 rows created.


PL/SQL procedure successfully completed.

old   2:   :N_BINS := &1;
new   2:   :N_BINS := 3;

PL/SQL procedure successfully completed.

Running for N_BINS value of...

    N_BINS
----------
         3

Queries
POS 3 bins

       BIN  BIN_TOTAL BIN_INT_DIFF BIN_EXT_DIFF
---------- ---------- ------------ ------------
         1   16682334         9997         6645
         2   16688979         9998         6645
         3   16685751         9997         6645

Elapsed: 00:00:00.01
SQL_ID  cms2vb3zvhzsb, child number 0
-------------------------------------
WITH items_desc AS (     SELECT item_name, item_value,            Mod
(Row_Number () OVER (ORDER BY item_value DESC), :N_BINS) + 1 bin
FROM items ), all_rows AS (     SELECT item_name, bin, item_value, Sum
(item_value) OVER (PARTITION BY bin) bin_total       FROM items_desc )
SELECT  /*+ gather_plan_statistics XPOS */        bin, Sum (item_value)
bin_total, Max (item_value) - Min (item_value) bin_int_diff,        Max
(Sum (item_value)) OVER () - Min (Sum (item_value)) OVER ()
bin_ext_diff   FROM all_rows GROUP BY bin ORDER BY bin
Plan hash value: 938376724
--------------------------------------------------------------------------------------------------------------------
| Id  | Operation             | Name  | Starts | E-Rows | A-Rows |   A-Time   | Buffers |  OMem |  1Mem | Used-Mem |
--------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT      |       |      1 |        |      3 |00:00:00.01 |      38 |       |       |          |
|   1 |  WINDOW BUFFER        |       |      1 |   9999 |      3 |00:00:00.01 |      38 |  2048 |  2048 | 2048  (0)|
|   2 |   SORT GROUP BY       |       |      1 |   9999 |      3 |00:00:00.01 |      38 |  2048 |  2048 | 2048  (0)|
|   3 |    VIEW               |       |      1 |   9999 |   9999 |00:00:00.01 |      38 |       |       |          |
|   4 |     WINDOW SORT       |       |      1 |   9999 |   9999 |00:00:00.01 |      38 |   337K|   337K|  299K (0)|
|   5 |      TABLE ACCESS FULL| ITEMS |      1 |   9999 |   9999 |00:00:00.01 |      38 |       |       |          |
--------------------------------------------------------------------------------------------------------------------

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.10
PLF Items_Binned

       BIN  BIN_TOTAL BIN_INT_DIFF BIN_EXT_DIFF
---------- ---------- ------------ ------------
         1   16685688         9998            2
         2   16685689         9990            2
         3   16685687         9997            2

Elapsed: 00:00:00.04
SQL_ID  gmsc0dm1u4bd8, child number 0
-------------------------------------
SELECT /*+ gather_plan_statistics XPLF */        item_name, bin,
item_value, Sum (item_value) OVER (PARTITION BY bin) bin_value   FROM
TABLE (Bin_Fit.Items_Binned (                      CURSOR (SELECT
item_name, item_value FROM items ORDER BY item_value DESC),
:N_BINS))  ORDER BY item_value DESC
Plan hash value: 3383417
-----------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                           | Name         | Starts | E-Rows | A-Rows |   A-Time   | Buffers |  OMem |  1Mem | Used-Mem |
-----------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                    |              |      1 |        |     99 |00:00:00.01 |     165 |       |       |          |
|   1 |  SORT ORDER BY                      |              |      1 |   8168 |     99 |00:00:00.01 |     165 |  9216 |  9216 | 8192  (0)|
|   2 |   WINDOW SORT                       |              |      1 |   8168 |     99 |00:00:00.01 |     165 |  9216 |  9216 | 8192  (0)|
|   3 |    COLLECTION ITERATOR PICKLER FETCH| ITEMS_BINNED |      1 |   8168 |     99 |00:00:00.01 |     165 |       |       |          |
|   4 |     SORT ORDER BY                   |              |      0 |     99 |      0 |00:00:00.01 |       0 | 73728 | 73728 |          |
|   5 |      TABLE ACCESS FULL              | ITEMS        |      0 |     99 |      0 |00:00:00.01 |       0 |       |       |          |
-----------------------------------------------------------------------------------------------------------------------------------------

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.10
RSF

       BIN  BIN_TOTAL BIN_INT_DIFF BIN_EXT_DIFF
---------- ---------- ------------ ------------
         1   16685687         9999            2
         2   16685689         9998            2
         3   16685688         9995            2

Elapsed: 00:00:05.06
SQL_ID  gyzn7bwb1p2qw, child number 0
-------------------------------------
WITH bins AS (        SELECT LEVEL bin, :N_BINS n_bins FROM DUAL
CONNECT BY LEVEL <= :N_BINS ), items_desc AS (        SELECT item_name,
item_value, Row_Number () OVER (ORDER BY item_value DESC) rn
FROM items ), rsf (bin, item_name, item_value, bin_value, lev,
bin_rank, n_bins) AS ( SELECT b.bin,        i.item_name,
i.item_value,        i.item_value,        1,        b.n_bins - i.rn +
1,        b.n_bins   FROM bins b   JOIN items_desc i     ON i.rn =
b.bin  UNION ALL SELECT r.bin,        i.item_name,        i.item_value,
r.bin_value + i.item_value,        r.lev + 1,        Row_Number
() OVER (ORDER BY r.bin_value + i.item_value),        r.n_bins   FROM
rsf r   JOIN items_desc i     ON i.rn = r.bin_rank + r.lev * r.n_bins )
SELECT  /*+ gather_plan_statistics XRSF_D */        r.item_name,
r.bin, r.item_value, r.bin_value   FROM rsf r  ORDER BY item_value DESC
Plan hash value: 3503473905
-----------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                                  | Name  | Starts | E-Rows | A-Rows |   A-Time   | Buffers |  OMem |  1Mem | Used-Mem |
-----------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                           |       |      1 |        |     99 |00:00:00.01 |      14 |       |       |          |
|   1 |  SORT ORDER BY                             |       |      1 |      2 |     99 |00:00:00.01 |      14 |  9216 |  9216 | 8192  (0)|
|   2 |   VIEW                                     |       |      1 |      2 |     99 |00:00:00.01 |      14 |       |       |          |
|   3 |    UNION ALL (RECURSIVE WITH) BREADTH FIRST|       |      1 |        |     99 |00:00:00.01 |      14 |  2048 |  2048 | 2048  (0)|
|*  4 |     HASH JOIN                              |       |      1 |      1 |      3 |00:00:00.01 |       7 |  2078K|  2078K|  930K (0)|
|   5 |      VIEW                                  |       |      1 |      1 |      3 |00:00:00.01 |       0 |       |       |          |
|   6 |       CONNECT BY WITHOUT FILTERING         |       |      1 |        |      3 |00:00:00.01 |       0 |  2048 |  2048 | 2048  (0)|
|   7 |        FAST DUAL                           |       |      1 |      1 |      1 |00:00:00.01 |       0 |       |       |          |
|   8 |      VIEW                                  |       |      1 |     99 |     99 |00:00:00.01 |       7 |       |       |          |
|   9 |       WINDOW SORT                          |       |      1 |     99 |     99 |00:00:00.01 |       7 | 11264 | 11264 |10240  (0)|
|  10 |        TABLE ACCESS FULL                   | ITEMS |      1 |     99 |     99 |00:00:00.01 |       7 |       |       |          |
|  11 |     WINDOW SORT                            |       |     33 |      1 |     96 |00:00:00.01 |       7 |  2048 |  2048 | 2048  (0)|
|* 12 |      HASH JOIN                             |       |     33 |      1 |     96 |00:00:00.01 |       7 |  1265K|  1265K|  939K (0)|
|  13 |       RECURSIVE WITH PUMP                  |       |     33 |        |     99 |00:00:00.01 |       0 |       |       |          |
|  14 |       BUFFER SORT (REUSE)                  |       |     33 |        |   3267 |00:00:00.01 |       7 | 73728 | 73728 |          |
|  15 |        VIEW                                |       |      1 |     99 |     99 |00:00:00.01 |       7 |       |       |          |
|  16 |         WINDOW SORT                        |       |      1 |     99 |     99 |00:00:00.01 |       7 | 11264 | 11264 |10240  (0)|
|  17 |          TABLE ACCESS FULL                 | ITEMS |      1 |     99 |     99 |00:00:00.01 |       7 |       |       |          |
-----------------------------------------------------------------------------------------------------------------------------------------
Predicate Information (identified by operation id):
---------------------------------------------------
4 - access("I"."RN"="B"."BIN")
12 - access("I"."RN"="R"."BIN_RANK"+"R"."LEV"*"R"."N_BINS")

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.13
Insert into temp table items_desc_temp

9999 rows created.

Elapsed: 00:00:00.02
SQL_ID  1fandzhqr8djq, child number 0
-------------------------------------
INSERT INTO items_desc_temp SELECT /*+ gather_plan_statistics XINS */
item_id, item_name, item_value, Row_Number () OVER (ORDER BY
item_value DESC) rn   FROM items
Plan hash value: 2685534282
---------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                | Name            | Starts | E-Rows | A-Rows |   A-Time   | Buffers |  OMem |  1Mem | Used-Mem |
---------------------------------------------------------------------------------------------------------------------------------
|   0 | INSERT STATEMENT         |                 |      1 |        |      0 |00:00:00.02 |     910 |       |       |          |
|   1 |  LOAD TABLE CONVENTIONAL | ITEMS_DESC_TEMP |      1 |        |      0 |00:00:00.02 |     910 |       |       |          |
|   2 |   WINDOW SORT            |                 |      1 |   9999 |   9999 |00:00:00.01 |      37 |   549K|   457K|  487K (0)|
|   3 |    TABLE ACCESS FULL     | ITEMS           |      1 |   9999 |   9999 |00:00:00.01 |      37 |       |       |          |
---------------------------------------------------------------------------------------------------------------------------------

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.10
RSF with temporary table

       BIN  BIN_TOTAL BIN_INT_DIFF BIN_EXT_DIFF
---------- ---------- ------------ ------------
         1   16685687         9999            2
         2   16685689         9998            2
         3   16685688         9995            2

Elapsed: 00:00:00.08
SQL_ID  1ztamyra9ssca, child number 0
-------------------------------------
WITH bins AS (        SELECT LEVEL bin, :N_BINS n_bins FROM DUAL
CONNECT BY LEVEL <= :N_BINS ), rsf (bin, item_name, item_value,
bin_value, lev, bin_rank, n_bins) AS ( SELECT b.bin,
i.item_name,        i.item_value,        i.item_value,        1,
b.n_bins - i.rn + 1,        b.n_bins   FROM bins b   JOIN
items_desc_temp i     ON i.rn = b.bin  UNION ALL SELECT r.bin,
i.item_name,        i.item_value,        r.bin_value + i.item_value,
r.lev + 1,        Row_Number () OVER (ORDER BY r.bin_value +
i.item_value),        r.n_bins   FROM rsf r   JOIN items_desc_temp i
ON i.rn = r.bin_rank + r.lev * r.n_bins ), all_rows AS (     SELECT
/*+ gather_plan_statistics XRSF_T */            item_name, bin,
item_value, bin_value       FROM rsf ) SELECT  /*+
gather_plan_statistics XPOS */        bin, Sum (item_value) bin_total,
Max (item_value) - Min (item_value) bin_int_diff,        Max (Sum
(item_value)) OVER () - Min (Sum (item_value)) OVER () bin_ext_diff
FROM all_r
Plan hash value: 3693981050
-------------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                                   | Name               | Starts | E-Rows | A-Rows |   A-Time   | Buffers |  OMem |  1Mem | Used-Mem |
-------------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                            |                    |      1 |        |      3 |00:00:00.07 |   14197 |       |       |          |
|   1 |  WINDOW BUFFER                              |                    |      1 |      2 |      3 |00:00:00.07 |   14197 |  2048 |  2048 | 2048  (0)|
|   2 |   SORT GROUP BY                             |                    |      1 |      2 |      3 |00:00:00.07 |   14197 |  2048 |  2048 | 2048  (0)|
|   3 |    VIEW                                     |                    |      1 |      2 |   9999 |00:00:00.08 |   14197 |       |       |          |
|   4 |     UNION ALL (RECURSIVE WITH) BREADTH FIRST|                    |      1 |        |   9999 |00:00:00.07 |   14197 |  2048 |  2048 |  613K (0)|
|   5 |      NESTED LOOPS                           |                    |      1 |      1 |      3 |00:00:00.01 |       7 |       |       |          |
|   6 |       VIEW                                  |                    |      1 |      1 |      3 |00:00:00.01 |       0 |       |       |          |
|   7 |        CONNECT BY WITHOUT FILTERING         |                    |      1 |        |      3 |00:00:00.01 |       0 |  2048 |  2048 | 2048  (0)|
|   8 |         FAST DUAL                           |                    |      1 |      1 |      1 |00:00:00.01 |       0 |       |       |          |
|   9 |       TABLE ACCESS BY INDEX ROWID BATCHED   | ITEMS_DESC_TEMP    |      3 |      1 |      3 |00:00:00.01 |       7 |       |       |          |
|* 10 |        INDEX RANGE SCAN                     | ITEMS_DESC_TEMP_N1 |      3 |      1 |      3 |00:00:00.01 |       6 |       |       |          |
|  11 |      WINDOW SORT                            |                    |   3333 |      1 |   9996 |00:00:00.04 |    6860 |  2048 |  2048 | 2048  (0)|
|  12 |       NESTED LOOPS                          |                    |   3333 |      1 |   9996 |00:00:00.03 |    6860 |       |       |          |
|  13 |        RECURSIVE WITH PUMP                  |                    |   3333 |        |   9999 |00:00:00.01 |       0 |       |       |          |
|  14 |        TABLE ACCESS BY INDEX ROWID BATCHED  | ITEMS_DESC_TEMP    |   9999 |      1 |   9996 |00:00:00.02 |    6860 |       |       |          |
|* 15 |         INDEX RANGE SCAN                    | ITEMS_DESC_TEMP_N1 |   9999 |      1 |   9996 |00:00:00.01 |    3495 |       |       |          |
-------------------------------------------------------------------------------------------------------------------------------------------------------
Predicate Information (identified by operation id):
---------------------------------------------------
10 - access("I"."RN"="B"."BIN")
15 - access("I"."RN"="R"."BIN_RANK"+"R"."LEV"*"R"."N_BINS")
Note
-----
- dynamic statistics used: dynamic sampling (level=2)
- this is an adaptive plan

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.15
COMMIT to delete temp table items_desc_temp

Commit complete.

Elapsed: 00:00:00.00
MOD with both Stew Ashton changes: removing measure from rule, and inline view

       BIN  BIN_TOTAL BIN_INT_DIFF BIN_EXT_DIFF
---------- ---------- ------------ ------------
         1   16685688         9998            2
         2   16685689         9990            2
         3   16685687         9997            2

Elapsed: 00:00:12.13
SQL_ID  45z3qkqnrvrv5, child number 0
-------------------------------------
SELECT /*+ gather_plan_statistics XMOD */        item_name, bin,
item_value, Max (bin_value) OVER (PARTITION BY bin) bin_value   FROM (
SELECT * FROM items   MODEL     DIMENSION BY (Row_Number() OVER (ORDER
BY item_value DESC) rn)     MEASURES (item_name,
item_value,               Row_Number() OVER (ORDER BY item_value DESC)
bin,               item_value bin_value,               Row_Number()
OVER (ORDER BY item_value DESC) rn_m,               0 min_bin,
Count(*) OVER () - :N_BINS - 1 n_iters     )     RULES
ITERATE(100000) UNTIL (ITERATION_NUMBER >= n_iters[1]) (
min_bin[1] = Min(rn_m) KEEP (DENSE_RANK FIRST ORDER BY bin_value)[rn <=
:N_BINS],       bin[ITERATION_NUMBER + :N_BINS + 1] = min_bin[1],
bin_value[min_bin[1]] = bin_value[CV()] + Nvl
(item_value[ITERATION_NUMBER + :N_BINS + 1], 0)     ) )  WHERE
item_name IS NOT NULL  ORDER BY item_value DESC
Plan hash value: 3793897966
---------------------------------------------------------------------------------------------------------------------
| Id  | Operation              | Name  | Starts | E-Rows | A-Rows |   A-Time   | Buffers |  OMem |  1Mem | Used-Mem |
---------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT       |       |      1 |        |     99 |00:00:00.01 |       7 |       |       |          |
|   1 |  SORT ORDER BY         |       |      1 |     99 |     99 |00:00:00.01 |       7 |  9216 |  9216 | 8192  (0)|
|   2 |   WINDOW SORT          |       |      1 |     99 |     99 |00:00:00.01 |       7 |  9216 |  9216 | 8192  (0)|
|*  3 |    VIEW                |       |      1 |     99 |     99 |00:00:00.01 |       7 |       |       |          |
|   4 |     SQL MODEL ORDERED  |       |      1 |     99 |     99 |00:00:00.01 |       7 |   860K|   860K|  514K (0)|
|   5 |      WINDOW SORT       |       |      1 |     99 |     99 |00:00:00.01 |       7 | 11264 | 11264 |10240  (0)|
|   6 |       TABLE ACCESS FULL| ITEMS |      1 |     99 |     99 |00:00:00.01 |       7 |       |       |          |
---------------------------------------------------------------------------------------------------------------------
Predicate Information (identified by operation id):
---------------------------------------------------
3 - filter("ITEM_NAME" IS NOT NULL)

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.10

'END:'||TO_CHAR(SYSDATE,'DD-MON-YY
----------------------------------
End: 26-MAR-2020 11:48:25

